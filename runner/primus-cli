#!/bin/bash
###############################################################################
# Copyright (c) 2025, Advanced Micro Devices, Inc. All rights reserved.
#
# See LICENSE for license information.
###############################################################################

set -euo pipefail

###############################################################################
# Exit Code Convention
#   0 = Success
#   1 = Library or dependency failure (e.g. missing file/lib)
#   2 = Invalid arguments or configuration
#   3 = Runtime execution failure
###############################################################################

print_usage() {
cat << EOF
Primus Unified Launcher CLI

Usage:
    primus-cli [global-options] <mode> [mode-args] -- [primus-commands and args]

Description:
    The unified entry point for all Primus workflows: distributed launch, containerization, and direct host training.
    Use '--' to separate mode-specific arguments from Primus Python CLI commands (train, benchmark, etc).

Global Options:
    --debug              Enable debug mode (verbose logging, set -x)
    --dry-run            Show commands without executing them
    --config FILE        Load configuration from specific file
    --version            Show version and exit
    -h, --help           Show this help message and exit

Supported modes:
    slurm      Launch distributed workflows via Slurm cluster (srun/sbatch)
    container  Launch workflows in a managed Docker/Podman container
    direct     Launch workflows directly on the current host or container

    Mode-specific help:
        primus-cli slurm --help         Show usage for slurm mode
        primus-cli container --help     Show usage for container mode (single node or debugging)
        primus-cli direct --help        Show usage for direct mode (host/container)

Examples:
    # Distributed GEMM benchmark using srun on 4 nodes:
    primus-cli slurm srun -N 4 -- benchmark gemm -M 4096 -N 4096 -K 4096

    # Distributed pretrain using sbatch on partition "AIG_Model":
    primus-cli slurm sbatch -N 8 -p AIG_Model -- train pretrain --config exp.yaml

    # Run GEMM benchmark in a managed container (single node):
    primus-cli container -- benchmark gemm -M 4096 -N 4096 -K 4096

    # Run pretrain directly on the host or inside an existing container:
    primus-cli direct -- train pretrain --config exp.yaml

    # Use debug mode for troubleshooting:
    primus-cli --debug direct -- train pretrain --config exp.yaml

    # Dry-run to see commands without execution:
    primus-cli --dry-run slurm srun -N 4 -- benchmark gemm

Notes:
    - [--] is required: it separates Primus launcher options (mode/mode-args) from Python CLI arguments.
    - All arguments after [--] are passed to the Primus Python CLI (see 'primus-cli direct -- --help').
    - For detailed documentation on each mode, use the '--help' flag after the mode name.
    - Primus CLI supports both training and benchmarking with Megatron, TorchTitan, and ROCm-optimized backends.

To see all supported Primus Python CLI commands and options:
    primus-cli direct -- --help
EOF
}

# Show help if called with -h, --help, or no arguments
if [[ $# -eq 0 ]]; then
    print_usage
    exit 0
fi

# Version
PRIMUS_CLI_VERSION="1.0.0"

# Resolve runner directory
RUNNER_DIR="$(cd "$(dirname "$(realpath "$0")")" && pwd)"

# Load common library (required)
# shellcheck disable=SC1091
source "$RUNNER_DIR/lib/common.sh" || {
    echo "[ERROR] Failed to load common library: $RUNNER_DIR/lib/common.sh" >&2
    exit 1
}

# Load configuration library (required)
# shellcheck disable=SC1091
source "$RUNNER_DIR/lib/config.sh" || {
    LOG_ERROR "[main] Failed to load config library: $RUNNER_DIR/lib/config.sh"
    exit 1
}

# Parse global options (single pass)
CONFIG_FILE=""
DEBUG_MODE=0
DRY_RUN_MODE=0
MODE_ARGS=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            print_usage
            exit 0
            ;;
        --version)
            LOG_INFO "Primus CLI version $PRIMUS_CLI_VERSION"
            exit 0
            ;;
        --config)
            if [[ -z "${2:-}" ]]; then
                LOG_ERROR "main --config requires a file path"
                exit 2
            fi
            if [[ ! -f "$2" ]]; then
                LOG_ERROR "[main] Config file not found: $2"
                exit 2
            fi
            CONFIG_FILE="$(realpath "$2")"
            shift 2
            ;;
        --debug)
            DEBUG_MODE=1
            shift
            ;;
        --dry-run)
            DRY_RUN_MODE=1
            shift
            ;;
        --)
            LOG_ERROR "[main] Missing <mode> argument before '--'"
            LOG_ERROR "Usage: primus-cli [global-options] <mode> [mode-args] -- [primus-commands and args]"
            LOG_ERROR "Example: primus-cli slurm --debug -N 1 -- container --debug benchmark gemm"
            exit 2
            ;;
        -*)
            LOG_ERROR "[main] Unknown global option: $1"
            LOG_ERROR "Try 'primus-cli --help' for more information."
            exit 2
            ;;
        *)
            # Not a global option, this is the mode or remaining args
            MODE_ARGS+=("$@")
            break
            ;;
    esac
done

# Restore mode and its arguments
set -- "${MODE_ARGS[@]}"

# Enable debug mode if set
if [[ "$DEBUG_MODE" == "1" ]]; then
    export PRIMUS_LOG_LEVEL="DEBUG"
    LOG_INFO "[main] Debug mode enabled (PRIMUS_LOG_LEVEL=DEBUG)"
fi

# Load configuration after parsing all options
load_config_auto "$CONFIG_FILE" "main" || {
    LOG_ERROR "[main] Configuration loading failed"
    exit 1
}

# Step 1: Load config and extract main.* parameters
declare -A main_config
# Extract all main.* config parameters using the generic function
extract_config_section "main" main_config || {
    LOG_ERROR "[main] Failed to extract main config section"
    exit 1
}

# Apply config values if not set via CLI
# Priority: CLI args > Config file > Default values
# Apply config overrides if not set via CLI
if [[ "$DEBUG_MODE" == "0" ]]; then
    debug_value="${main_config[debug]:-false}"
    if [[ "$debug_value" == "true" || "$debug_value" == "1" ]]; then
        DEBUG_MODE=1
        export PRIMUS_LOG_LEVEL="DEBUG"
        LOG_INFO "[main] Debug mode enabled via config (PRIMUS_LOG_LEVEL=DEBUG)"
    fi
fi

if [[ "$DRY_RUN_MODE" == "0" ]]; then
    dry_run_value="${main_config[dry_run]:-false}"
    if [[ "$dry_run_value" == "true" || "$dry_run_value" == "1" ]]; then
        DRY_RUN_MODE=1
        LOG_INFO "[main] Dry-run mode enabled via config"
    fi
fi

# Run subscript from runner directory
run_subscript() {
    local script="$1"
    shift

    local script_path="$RUNNER_DIR/$script"

    if [[ ! -f "$script_path" ]]; then
        LOG_ERROR "[main] Script not found: $script"
        exit 1
    fi

    # Split args around the first '--' only
    local global_opts=()
    local mode_opts=()
    local primus_args=()
    local found_separator=false

    for arg in "$@"; do
        if [[ "$arg" == "--" ]] && [[ "$found_separator" == false ]]; then
            # First '--' separator, switch to primus args
            found_separator=true
            continue
        fi

        if [[ "$found_separator" == false ]]; then
            mode_opts+=("$arg")
        else
            # Everything after first '--', including subsequent '--'
            primus_args+=("$arg")
        fi
    done

    # Inject global flags (only if not already present in mode_opts)
    [[ -n "$CONFIG_FILE" ]] && global_opts+=(--config "$CONFIG_FILE")
    # Only add --debug to global_opts if DEBUG_MODE is set and not already in mode_opts
    if [[ "$DEBUG_MODE" == "1" ]]; then
        local has_debug=false
        for opt in "${mode_opts[@]}"; do
            [[ "$opt" == "--debug" ]] && has_debug=true && break
        done
        [[ "$has_debug" == false ]] && global_opts+=(--debug)
    fi

    local cmd="bash $script_path ${global_opts[*]} ${mode_opts[*]} -- ${primus_args[*]}"

    # Always display command information (regardless of dry-run mode)
    # Extract mode name from script (e.g., "primus-cli-slurm.sh" -> "slurm")
    local mode_name="${script#primus-cli-}"
    mode_name="${mode_name%.sh}"

    # Find the last '--' in primus_args to separate mode chain from final Primus Python CLI args
    local final_mode_args=()
    local final_primus_args=()
    local last_separator_idx=-1

    # Find the index of the last '--' in primus_args
    for i in "${!primus_args[@]}"; do
        if [[ "${primus_args[$i]}" == "--" ]]; then
            last_separator_idx=$i
        fi
    done

    if [[ $last_separator_idx -ge 0 ]]; then
        # Split at the last '--'
        for i in "${!primus_args[@]}"; do
            if [[ $i -lt $last_separator_idx ]]; then
                final_mode_args+=("${primus_args[$i]}")
            elif [[ $i -gt $last_separator_idx ]]; then
                final_primus_args+=("${primus_args[$i]}")
            fi
        done

        # Build display string for mode arguments with mode name prefix
        local display_mode_str="$mode_name ${mode_opts[*]}"
        if [[ ${#final_mode_args[@]} -gt 0 ]]; then
            display_mode_str="$mode_name ${mode_opts[*]} -- ${final_mode_args[*]}"
        fi
    else
        # No additional '--' found, use primus_args as is
        local display_mode_str="$mode_name ${mode_opts[*]}"
        final_primus_args=("${primus_args[@]}")
    fi

    # Build comprehensive global options display
    local global_display=("${global_opts[@]}")
    [[ -n "$CONFIG_FILE" ]] && global_display+=("--config" "$CONFIG_FILE")
    [[ "$DEBUG_MODE" == "1" ]] && global_display+=("--debug")
    [[ "$DRY_RUN_MODE" == "1" ]] && global_display+=("--dry-run")

    # Display command information
    PRINT_INFO_RANK0 ""
    if [[ "$DRY_RUN_MODE" == "1" ]]; then
        PRINT_INFO_RANK0 "========== [DRY RUN] Primus CLI =========="
    else
        PRINT_INFO_RANK0 "========== Primus CLI =========="
    fi
    PRINT_INFO_RANK0 "  Script             : $script"
    PRINT_INFO_RANK0 "--------------------------------------------------"
    PRINT_INFO_RANK0 "  [Global   Options] : ${global_display[*]:-(none)}"
    PRINT_INFO_RANK0 "  [Mode   Arguments] : ${display_mode_str:-(none)}"
    PRINT_INFO_RANK0 "  [Primus Arguments] : ${final_primus_args[*]:-(none)}"
    PRINT_INFO_RANK0 "--------------------------------------------------"
    if [[ "$DRY_RUN_MODE" == "1" ]]; then
        PRINT_INFO_RANK0 "  Would Execute:"
    else
        PRINT_INFO_RANK0 "  Executing:"
    fi
    PRINT_INFO_RANK0 "    $cmd"
    PRINT_INFO_RANK0 "=================================================="
    PRINT_INFO_RANK0 ""

    # In dry-run mode, exit after displaying the command
    if [[ "$DRY_RUN_MODE" == "1" ]]; then
        LOG_INFO "[main] Dry-run mode: command not executed"
        exit 0
    fi

    # Execute the command
    LOG_INFO "[main] Executing command..."
    exec bash "$script_path" "${global_opts[@]}" "${mode_opts[@]}" -- "${primus_args[@]}"
}

# Check if mode is provided
if [[ $# -lt 1 ]]; then
    LOG_ERROR "[main] Mode argument is required"
    echo "" >&2
    print_usage >&2
    exit 2
fi

mode="$1"; shift

script_name="primus-cli-${mode}.sh"
script_path="$RUNNER_DIR/$script_name"

if [[ ! -f "$script_path" ]]; then
    LOG_ERROR "[main] Unknown or unsupported mode: $mode"
    print_usage >&2
    exit 2
fi

run_subscript "$script_name" "$@"
