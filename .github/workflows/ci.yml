name: Primus CLI CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  lint:
    name: Shell Script Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run ShellCheck on runner scripts
        run: |
          find runner -name "*.sh" -type f | xargs shellcheck -e SC1091 -e SC2164

      - name: Run ShellCheck on main entry points
        run: |
          shellcheck -e SC1091 runner/primus-cli
          shellcheck -e SC1091 runner/primus-cli-container.sh
          shellcheck -e SC1091 runner/primus-cli-entrypoint.sh
          shellcheck -e SC1091 runner/primus-cli-slurm-entry.sh

  test:
    name: Run CLI Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          export NODE_RANK=0
          export PATH="$PWD/runner:$PATH"

      - name: Run common library tests
        run: |
          export NODE_RANK=0
          bash tests/cli/test_common.sh

      - name: Run validation library tests
        run: |
          export NODE_RANK=0
          bash tests/cli/test_validation.sh

      - name: Run configuration tests
        run: |
          export NODE_RANK=0
          bash tests/cli/test_config.sh

      - name: Run primus-cli tests
        run: |
          export NODE_RANK=0
          bash tests/cli/test_primus_cli.sh

      - name: Run helper tests
        run: |
          export NODE_RANK=0
          bash tests/cli/test_helpers.sh

  test-all:
    name: Run All Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run all CLI tests
        run: |
          export NODE_RANK=0
          bash tests/cli/run_all_tests.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: tests/cli/*.log

  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check syntax of all bash scripts
        run: |
          EXIT_CODE=0
          for script in $(find runner tests -name "*.sh" -o -name "primus-cli"); do
            echo "Checking: $script"
            bash -n "$script" || EXIT_CODE=1
          done
          exit $EXIT_CODE

  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation exists
        run: |
          test -f README.md
          test -f docs/USER_GUIDE.md
          test -f docs/BEST_PRACTICES.md
          test -f docs/CONFIGURATION_GUIDE.md
          test -f runner/QUICK_REFERENCE.md

      - name: Check markdown syntax
        uses: actionshub/markdownlint@main
        with:
          path: docs/
          ignore: node_modules
        continue-on-error: true

  version-check:
    name: Version Consistency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check VERSION file exists
        run: test -f VERSION

      - name: Verify version format
        run: |
          VERSION=$(cat VERSION)
          echo "Version: $VERSION"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "ERROR: Invalid version format"
            exit 1
          fi

  examples-check:
    name: Check Examples
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check example files exist
        run: |
          test -f examples/primusrc.example
          test -f examples/primus.yaml.example

      - name: Validate YAML examples
        run: |
          sudo apt-get update && sudo apt-get install -y python3-yaml
          python3 -c "import yaml; yaml.safe_load(open('examples/primus.yaml.example'))"

  integration:
    name: Integration Test (Dry Run)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test primus-cli --version
        run: |
          export NODE_RANK=0
          bash runner/primus-cli --version

      - name: Test primus-cli --help
        run: |
          export NODE_RANK=0
          bash runner/primus-cli --help

      - name: Test primus-cli --show-config
        run: |
          export NODE_RANK=0
          bash runner/primus-cli --show-config

      - name: Test dry-run mode
        run: |
          export NODE_RANK=0
          bash runner/primus-cli --dry-run direct -- train pretrain --config test.yaml || true

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, test, test-all, syntax-check, docs-check, version-check, examples-check, integration]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "=== CI Summary ==="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Test All: ${{ needs.test-all.result }}"
          echo "Syntax Check: ${{ needs.syntax-check.result }}"
          echo "Docs Check: ${{ needs.docs-check.result }}"
          echo "Version Check: ${{ needs.version-check.result }}"
          echo "Examples Check: ${{ needs.examples-check.result }}"
          echo "Integration: ${{ needs.integration.result }}"

          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.test-all.result }}" != "success" ]] || \
             [[ "${{ needs.syntax-check.result }}" != "success" ]] || \
             [[ "${{ needs.integration.result }}" != "success" ]]; then
            echo "❌ CI FAILED"
            exit 1
          else
            echo "✅ CI PASSED"
          fi
