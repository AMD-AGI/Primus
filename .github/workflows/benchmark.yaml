name: Primus-Benchmark

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 * * *'

env:
  PRIMUS_TURBO_COMMIT: 5233748e9c5c5795a6484ab31ece47c442d29ec2 # feat(mxfp4): refactor gemm mxfp4 and mxfp8. fuse transpose, hadamard transform and quantization. (#195)
  BENCHMARK_ROOT_DIR: /wekafs/primus/benchmark

jobs:
  run-benchmark-multinode:
    env:
      PRIMUS_WORKDIR: /wekafs/primus-data/primus_safe_ci/torch
      GPU_NAME: MI325  # Change this to your GPU model
      DATA_PATH: /wekafs/primus-data
      HF_TOKEN: ${{secrets.HF_TOKEN}}
    runs-on: [primus-lm-bench-multinode-p8hz7]
    steps:
      - run: echo "ðŸŽ‰ Begin Primus Benchmark."
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Show Environment Info
        run: |
          echo "Hostname: $(hostname)"
          echo "PWD: $(pwd)"
          echo "HOME: $HOME"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "Runner Temp Dir: $RUNNER_TEMP"
          echo "Runner Tool Cache: $RUNNER_TOOL_CACHE"
      - name: Set BENCHMARK_PATH
        run: |
          BENCHMARK_DATE=$(date +%Y%m%d)
          BENCHMARK_DATE_DIR="${BENCHMARK_ROOT_DIR}/${BENCHMARK_DATE}"
          BENCHMARK_LOG_DIR="${BENCHMARK_DATE_DIR}/${GPU_NAME}"
          mkdir -p "${BENCHMARK_LOG_DIR}"
          echo "BENCHMARK_DATE_DIR=${BENCHMARK_DATE_DIR}" >> $GITHUB_ENV
          echo "BENCHMARK_LOG_DIR=${BENCHMARK_LOG_DIR}" >> $GITHUB_ENV
      - name: "[SaFE] 4node benchmark"
        timeout-minutes: 300  # 5 hours for multi-node training
        continue-on-error: true
        run: |
          python tools/daily/safe_wrapper.py \
          --config examples/megatron/configs/MI300X/grok1-BF16-pretrain.yaml,examples/megatron/configs/MI300X/grok1-FP8-pretrain.yaml \
          --gpus 8 \
          --num-nodes 4 \
          --timeout 18000
      - name: Generate Summary Report
        run: |
          echo "Generate Summary Report"
          python3 tools/daily/daily_report.py --report-csv-path "${BENCHMARK_DATE_DIR}/summary.csv" --benchmark-log-dir "${BENCHMARK_LOG_DIR}"
