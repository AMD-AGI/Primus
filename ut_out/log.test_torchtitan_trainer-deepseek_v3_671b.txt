W1031 06:37:38.814000 73733 torch/distributed/run.py:803]
W1031 06:37:38.814000 73733 torch/distributed/run.py:803] *****************************************
W1031 06:37:38.814000 73733 torch/distributed/run.py:803] Setting OMP_NUM_THREADS environment variable for each process to be 1 in default, to avoid your system being overloaded, please further tune the variable for optimal performance in your application as needed.
W1031 06:37:38.814000 73733 torch/distributed/run.py:803] *****************************************
[Primus CLI] HF_HOME already set: /shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/data/huggingface
[PrimusConfig] Detected unknown override keys: ['model']
[Primus] sys.path.insert: /shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/third_party/torchtitan
[[32m20251031 06:37:40[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1m[PrimusPatch][AMP] nn.Embedding.__init__ patched for AMP/mixed precision alignment.[0m
[[32m20251031 06:37:40[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1m[PrimusPatch][Dataset] Patched datasets.load_dataset successfully.[0m
[[32m20251031 06:37:41[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1m[PrimusPatch][DCP] Installed fallback for missing torch.distributed.checkpoint._consolidate_hf_safetensors.consolidate_safetensors_files_on_every_rank, HuggingFace safetensors export will be disabled.[0m
[[32m20251031 06:37:41[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1m[PrimusPatch][Pipe] Installed fallback: ScheduleDualPipeV -> Schedule1F1B[0m
[[32m20251031 06:37:41[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1m[PrimusPatch][FlexAttn] AuxOutput not found. This torch build predates the new debug/profiling return type. Injecting a lightweight stub so Titan model imports can succeed.[0m
[[32m20251031 06:37:41[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1m[PrimusPatch][FlexAttn] Injected fallback AuxOutput stub (Titan does not rely on this).[0m
[[32m20251031 06:37:41[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1m[PrimusPatch][Checkpoint] checkpoint_wrapper patched successfully[0m
[[32m20251031 06:37:41[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1m[PrimusPatch][ModelOverride] Applying model_overrides: {'model': {'n_layers': 4, 'n_dense_layers': 1, 'moe_args': {'use_grouped_mm': False}}}[0m
[[32m20251031 06:37:41[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1m[PrimusPatch][ModelOverride] Applying overrides: {'model.n_layers': 4, 'model.n_dense_layers': 1, 'model.moe_args.use_grouped_mm': False}[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1m[PrimusPatch][ModelOverride] get_train_spec for 'deepseek_v3' successfully monkey patched (flavor=671B).[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1mMokey patch torchtitan logger...[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1mLoaded and merged custom JobConfig from primus.backends.torchtitan.primus_turbo_extensions.config_extension[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1m========== TorchTitan Config ==========[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments activation_checkpoint.early_stop.................................. False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments activation_checkpoint.mode........................................ full[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments activation_checkpoint.per_op_sac_force_recompute_mm_shapes_by_fqns ['moe.router.gate'][0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments activation_checkpoint.selective_ac_option......................... op[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.async_mode............................................. disabled[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.create_seed_checkpoint................................. False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.enable................................................. False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.enable_first_step_checkpoint........................... False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.exclude_from_loading................................... [][0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.export_dtype........................................... float32[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.folder................................................. checkpoint[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.initial_load_in_hf..................................... False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.initial_load_model_only................................ True[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.initial_load_path...................................... None[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.interval............................................... 10[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.keep_latest_k.......................................... 10[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.last_save_in_hf........................................ False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.last_save_model_only................................... True[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments checkpoint.load_step.............................................. -1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments comm.init_timeout_seconds......................................... 300[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments comm.save_traces_folder........................................... comm_traces[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments comm.trace_buf_size............................................... 20000[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments comm.train_timeout_seconds........................................ 100[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments compile.components................................................ ['loss'][0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments compile.enable.................................................... True[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments experimental.custom_args_module................................... primus.backends.torchtitan.primus_turbo_extensions.config_extension[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments experimental.custom_import........................................ [0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments fault_tolerance.enable............................................ False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments fault_tolerance.group_size........................................ 0[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments fault_tolerance.min_replica_size.................................. 1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments fault_tolerance.process_group..................................... gloo[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments fault_tolerance.process_group_timeout_ms.......................... 10000[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments fault_tolerance.replica_id........................................ 0[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments fault_tolerance.semi_sync_method.................................. None[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments float8.emulate.................................................... False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments float8.enable_fsdp_float8_all_gather.............................. False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments float8.filter_fqns................................................ [][0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments float8.moe_fqns_prototype......................................... [][0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments float8.precompute_float8_dynamic_scale_for_fsdp................... False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments float8.recipe_name................................................ None[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments job.config_file................................................... None[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments job.description................................................... DeepSeek-V3 671B model training[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments job.dump_folder................................................... ./outputs[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments job.print_args.................................................... False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments lr_scheduler.decay_ratio.......................................... 0.8[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments lr_scheduler.decay_type........................................... cosine[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments lr_scheduler.min_lr_factor........................................ 0.1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments lr_scheduler.warmup_steps......................................... 200[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments memory_estimation.disable_fake_mode............................... False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments memory_estimation.enable.......................................... False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments metrics.disable_color_printing.................................... False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments metrics.enable_tensorboard........................................ False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments metrics.enable_wandb.............................................. False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments metrics.log_freq.................................................. 10[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments metrics.save_for_all_ranks........................................ False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments metrics.save_tb_folder............................................ tb[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments model.converters.................................................. [][0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments model.flavor...................................................... 671B[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments model.hf_assets_path.............................................. /shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/data/torchtitan/DeepSeek-V3.1-Base[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments model.name........................................................ deepseek_v3[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments model.print_after_conversion...................................... False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments model.tokenizer_path.............................................. None[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments mx.filter_fqns.................................................... ['output'][0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments mx.moe_fqns_prototype............................................. [][0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments mx.mxfp8_dim1_cast_kernel_choice.................................. triton[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments mx.recipe_name.................................................... mxfp8_cublas[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments optimizer.beta1................................................... 0.9[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments optimizer.beta2................................................... 0.95[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments optimizer.early_step_in_backward.................................. False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments optimizer.eps..................................................... 1e-08[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments optimizer.implementation.......................................... fused[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments optimizer.lr...................................................... 0.00022[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments optimizer.name.................................................... AdamW[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments optimizer.weight_decay............................................ 0.1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.context_parallel_degree............................... 1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.context_parallel_rotate_method........................ allgather[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.data_parallel_replicate_degree........................ 1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.data_parallel_shard_degree............................ -1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.disable_loss_parallel................................. False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.enable_async_tensor_parallel.......................... False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.enable_compiled_autograd.............................. False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.expert_parallel_degree................................ 8[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.expert_tensor_parallel_degree......................... 1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.fsdp_reshard_after_forward............................ default[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.module_fqns_per_model_part............................ None[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.pipeline_parallel_degree.............................. 1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.pipeline_parallel_first_stage_less_layers............. 1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.pipeline_parallel_last_stage_less_layers.............. 1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.pipeline_parallel_layers_per_stage.................... None[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.pipeline_parallel_microbatch_size..................... 1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.pipeline_parallel_schedule............................ Interleaved1F1B[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.pipeline_parallel_schedule_csv........................ [0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.pipeline_parallel_split_points........................ [][0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments parallelism.tensor_parallel_degree................................ 1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments primus_turbo.enable_attention_float8.............................. False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments primus_turbo.enable_embedding_autocast............................ True[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments primus_turbo.enable_primus_turbo.................................. True[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments primus_turbo.use_turbo_async_tp................................... True[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments primus_turbo.use_turbo_attention.................................. True[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments primus_turbo.use_turbo_mx_linear.................................. True[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments profiling.enable_memory_snapshot.................................. False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments profiling.enable_profiling........................................ False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments profiling.profile_freq............................................ 10[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments profiling.save_memory_snapshot_folder............................. memory_snapshot[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments profiling.save_traces_folder...................................... profile_trace[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.dataset.................................................. c4[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.dataset_path............................................. None[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.deterministic............................................ False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.enable_cpu_offload....................................... False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.gc_debug................................................. False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.gc_freq.................................................. 50[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.global_batch_size........................................ -1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.local_batch_size......................................... 4[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.max_norm................................................. 1.0[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.mixed_precision_param.................................... bfloat16[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.mixed_precision_reduce................................... float32[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.seed..................................................... None[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.seq_len.................................................. 4096[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments training.steps.................................................... 3[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments validation.dataset................................................ c4_validation[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments validation.dataset_path........................................... None[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments validation.enable................................................. False[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments validation.freq................................................... 10[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments validation.local_batch_size....................................... 8[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments validation.seq_len................................................ 2048[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[1mINFO [0m] [1marguments validation.steps.................................................. -1[0m
[[32m20251031 06:37:43[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1mTorchtitanPretrainTrainer: Patch Turbo Attention[0m
[[32m20251031 06:37:44[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1mTorchtitanPretrainTrainer: Patch Turbo MXLinear[0m
[[32m20251031 06:37:44[0m][[36mrank-1/8[0m][[1mINFO [0m] [1mEnable primus turbo extension...[0m
[[32m20251031 06:37:44[0m][[36mrank-1/8[0m][[1mINFO [0m] [1mStarting job: DeepSeek-V3 671B model training[0m
[[32m20251031 06:37:44[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1mENV[TORCH_NCCL_ASYNC_ERROR_HANDLING] = 1 will be overridden to 3 based on job config[0m
[[32m20251031 06:37:44[0m][[36mrank-1/8[0m][[1mINFO [0m] [1mBuilding 2-D device mesh with ['dp_shard_mod_ep', 'dp_shard_in_ep'], [1, 8][0m
[[32m20251031 06:37:44[0m][[36mrank-1/8[0m][[1mINFO [0m] [1m[GC] Initial GC collection 0.00 seconds[0m
[[32m20251031 06:37:47[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1m[PrimusPatch][ModelOverride] Successfully patched model_args['671B'] for 'deepseek_v3' with {'model.n_layers': 4, 'model.n_dense_layers': 1, 'model.moe_args.use_grouped_mm': False}. Diff(beforeâ†’after): {'_enforced': 'This field is used to enforce all fields have defaults.', 'max_batch_size': 8, 'max_seq_len': 16384, 'vocab_size': 129280, 'dim': 7168, 'inter_dim': 18432, 'moe_inter_dim': 2048, 'n_layers': 61, 'n_dense_layers': 3, 'n_heads': 128, 'norm_eps': 1e-05, 'moe_args': {'num_experts': 256, 'num_shared_experts': 1, 'score_func': 'sigmoid', 'route_norm': True, 'route_scale': 2.5, 'score_before_experts': False, 'top_k': 8, 'use_grouped_mm': True, 'load_balance_coeff': 0.001}, 'n_expert_groups': 8, 'n_limited_groups': 4, 'q_lora_rank': 1536, 'kv_lora_rank': 512, 'qk_nope_head_dim': 128, 'qk_rope_head_dim': 64, 'v_head_dim': 128, 'use_flex_attn': True, 'attn_mask_type': 'block_causal', 'original_seq_len': 4096, 'rope_theta': 10000.0, 'rope_factor': 40, 'beta_fast': 32, 'beta_slow': 1, 'mscale': 1.0} â†’ {'_enforced': 'This field is used to enforce all fields have defaults.', 'max_batch_size': 8, 'max_seq_len': 16384, 'vocab_size': 129280, 'dim': 7168, 'inter_dim': 18432, 'moe_inter_dim': 2048, 'n_layers': 4, 'n_dense_layers': 1, 'n_heads': 128, 'norm_eps': 1e-05, 'moe_args': {'num_experts': 256, 'num_shared_experts': 1, 'score_func': 'sigmoid', 'route_norm': True, 'route_scale': 2.5, 'score_before_experts': False, 'top_k': 8, 'use_grouped_mm': False, 'load_balance_coeff': 0.001}, 'n_expert_groups': 8, 'n_limited_groups': 4, 'q_lora_rank': 1536, 'kv_lora_rank': 512, 'qk_nope_head_dim': 128, 'qk_rope_head_dim': 64, 'v_head_dim': 128, 'use_flex_attn': True, 'attn_mask_type': 'block_causal', 'original_seq_len': 4096, 'rope_theta': 10000.0, 'rope_factor': 40, 'beta_fast': 32, 'beta_slow': 1, 'mscale': 1.0}[0m
[[32m20251031 06:37:47[0m][[36mrank-1/8[0m][[1mINFO [0m] [1mLoading tokenizer from tokenizer.json[0m
[[32m20251031 06:37:47[0m][[36mrank-1/8[0m][[1mINFO [0m] [1mPreparing c4 dataset from allenai/c4[0m
[[32m20251031 06:37:47[0m][[36mrank-1/8[0m][[33m[1mWARNING[0m] [33m[1m[PrimusPatch][MockDataset] load_dataset('allenai/c4') is mocked.[0m
[[32m20251031 06:37:48[0m][[36mrank-1/8[0m][[1mINFO [0m] [1mBuilding deepseek_v3 671B with DeepSeekV3ModelArgs(_enforced='This field is used to enforce all fields have defaults.', max_batch_size=8, max_seq_len=4096, vocab_size=129280, dim=7168, inter_dim=18432, moe_inter_dim=2048, n_layers=4, n_dense_layers=1, n_heads=128, norm_eps=1e-05, moe_args=MoEArgs(num_experts=256, num_shared_experts=1, score_func='sigmoid', route_norm=True, route_scale=2.5, score_before_experts=False, top_k=8, use_grouped_mm=False, load_balance_coeff=0.001), n_expert_groups=8, n_limited_groups=4, q_lora_rank=1536, kv_lora_rank=512, qk_nope_head_dim=128, qk_rope_head_dim=64, v_head_dim=128, use_flex_attn=True, attn_mask_type='block_causal', original_seq_len=4096, rope_theta=10000.0, rope_factor=40, beta_fast=32, beta_slow=1, mscale=1.0)[0m
[rank1]: Traceback (most recent call last):
[rank1]:   File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/primus/cli/main.py", line 43, in <module>
[rank1]:     main()
[rank1]:   File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/primus/cli/main.py", line 35, in main
[rank1]:     args.func(args, unknown_args)
[rank1]:   File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/primus/cli/train_cli.py", line 15, in run
[rank1]:     launch_pretrain_from_cli(args, overrides)
[rank1]:   File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/primus/pretrain.py", line 164, in launch_pretrain_from_cli
[rank1]:     launch_pretrain_trainer(primus_cfg=primus_cfg, extra_args=unknown_overrides)
[rank1]:   File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/primus/pretrain.py", line 133, in launch_pretrain_trainer
[rank1]:     trainer.init()
[rank1]:   File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/primus/modules/trainer/torchtitan/pre_trainer.py", line 89, in init
[rank1]:     self.trainer = self.TrainerClass(self.titan_config)
[rank1]:   File "/opt/venv/lib/python3.10/site-packages/torch/distributed/elastic/multiprocessing/errors/__init__.py", line 357, in wrapper
[rank1]:     return f(*args, **kwargs)
[rank1]:   File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/third_party/torchtitan/torchtitan/train.py", line 158, in __init__
[rank1]:     model = self.train_spec.model_cls(model_args)
[rank1]:   File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/third_party/torchtitan/torchtitan/models/deepseek_v3/model/model.py", line 330, in __init__
[rank1]:     self.layers[str(layer_id)] = TransformerBlock(layer_id, model_args)
[rank1]:   File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/third_party/torchtitan/torchtitan/models/deepseek_v3/model/model.py", line 270, in __init__
[rank1]:     self.attention = Attention(model_args)
[rank1]:   File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/third_party/torchtitan/torchtitan/models/llama3/model/model.py", line 134, in __init__
[rank1]:     if model_args.n_kv_heads is None
[rank1]: AttributeError: 'DeepSeekV3ModelArgs' object has no attribute 'n_kv_heads'. Did you mean: 'n_heads'?
[rank1]:[W1031 06:37:48.482545940 ProcessGroupNCCL.cpp:1522] Warning: WARNING: destroy_process_group() was not called before program exit, which can leak resources. For more info, please see https://pytorch.org/docs/stable/distributed.html#shutdown (function operator())
W1031 06:37:49.786000 73733 torch/distributed/elastic/multiprocessing/api.py:906] Sending process 73800 closing signal SIGTERM
W1031 06:37:49.787000 73733 torch/distributed/elastic/multiprocessing/api.py:906] Sending process 73801 closing signal SIGTERM
W1031 06:37:49.788000 73733 torch/distributed/elastic/multiprocessing/api.py:906] Sending process 73802 closing signal SIGTERM
W1031 06:37:49.789000 73733 torch/distributed/elastic/multiprocessing/api.py:906] Sending process 73803 closing signal SIGTERM
W1031 06:37:49.791000 73733 torch/distributed/elastic/multiprocessing/api.py:906] Sending process 73804 closing signal SIGTERM
W1031 06:37:49.792000 73733 torch/distributed/elastic/multiprocessing/api.py:906] Sending process 73806 closing signal SIGTERM
W1031 06:37:49.792000 73733 torch/distributed/elastic/multiprocessing/api.py:906] Sending process 73807 closing signal SIGTERM
E1031 06:37:50.108000 73733 torch/distributed/elastic/multiprocessing/api.py:880] failed (exitcode: 1) local_rank: 5 (pid: 73805) of binary: /opt/venv/bin/python
E1031 06:37:50.111000 73733 torch/distributed/elastic/multiprocessing/errors/error_handler.py:141] no error file defined for parent, to copy child error file (/tmp/torchelastic_4484iggr/none_622qy2ik/attempt_0/5/error.json)
Traceback (most recent call last):
  File "/opt/venv/bin/torchrun", line 7, in <module>
    sys.exit(main())
  File "/opt/venv/lib/python3.10/site-packages/torch/distributed/elastic/multiprocessing/errors/__init__.py", line 357, in wrapper
    return f(*args, **kwargs)
  File "/opt/venv/lib/python3.10/site-packages/torch/distributed/run.py", line 936, in main
    run(args)
  File "/opt/venv/lib/python3.10/site-packages/torch/distributed/run.py", line 927, in run
    elastic_launch(
  File "/opt/venv/lib/python3.10/site-packages/torch/distributed/launcher/api.py", line 151, in __call__
    return launch_agent(self._config, self._entrypoint, list(args))
  File "/opt/venv/lib/python3.10/site-packages/torch/distributed/launcher/api.py", line 288, in launch_agent
    raise ChildFailedError(
torch.distributed.elastic.multiprocessing.errors.ChildFailedError:
============================================================
primus/cli/main.py FAILED
------------------------------------------------------------
Failures:
  <NO_OTHER_FAILURES>
------------------------------------------------------------
Root Cause (first observed failure):
[0]:
  time      : 2025-10-31_06:37:48
  host      : gpu-41
  rank      : 5 (local_rank: 5)
  exitcode  : 1 (pid: 73805)
  error_file: /tmp/torchelastic_4484iggr/none_622qy2ik/attempt_0/5/error.json
  traceback : Traceback (most recent call last):
    File "/opt/venv/lib/python3.10/site-packages/torch/distributed/elastic/multiprocessing/errors/__init__.py", line 357, in wrapper
      return f(*args, **kwargs)
    File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/third_party/torchtitan/torchtitan/train.py", line 158, in __init__
      model = self.train_spec.model_cls(model_args)
    File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/third_party/torchtitan/torchtitan/models/deepseek_v3/model/model.py", line 330, in __init__
      self.layers[str(layer_id)] = TransformerBlock(layer_id, model_args)
    File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/third_party/torchtitan/torchtitan/models/deepseek_v3/model/model.py", line 270, in __init__
      self.attention = Attention(model_args)
    File "/shared/amdgpu/home/xiaoming_peng_qle/workspace/dev/Primus-CLI/third_party/torchtitan/torchtitan/models/llama3/model/model.py", line 134, in __init__
      if model_args.n_kv_heads is None
  AttributeError: 'DeepSeekV3ModelArgs' object has no attribute 'n_kv_heads'. Did you mean: 'n_heads'?

============================================================
