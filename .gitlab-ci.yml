# Primus CLI GitLab CI/CD Pipeline

stages:
  - lint
  - test
  - integration
  - deploy

variables:
  NODE_RANK: "0"

# Lint Stage
shellcheck:
  stage: lint
  image: koalaman/shellcheck-alpine:latest
  script:
    - echo "Running ShellCheck..."
    - find runner -name "*.sh" -type f | xargs shellcheck -e SC1091 -e SC2164 || true
    - shellcheck -e SC1091 runner/primus-cli || true
    - shellcheck -e SC1091 runner/primus-cli-container.sh || true
    - shellcheck -e SC1091 runner/primus-cli-entrypoint.sh || true
    - shellcheck -e SC1091 runner/primus-cli-slurm-entry.sh || true
  allow_failure: true
  tags:
    - docker

syntax-check:
  stage: lint
  image: bash:latest
  script:
    - echo "Checking bash syntax..."
    - |
      EXIT_CODE=0
      for script in $(find runner tests -name "*.sh" -o -name "primus-cli"); do
        echo "Checking: $script"
        bash -n "$script" || EXIT_CODE=1
      done
      exit $EXIT_CODE
  tags:
    - docker

# Test Stage
test-common:
  stage: test
  image: bash:latest
  script:
    - echo "Running common library tests..."
    - bash tests/cli/test_common.sh
  artifacts:
    when: always
    paths:
      - tests/cli/*.log
    expire_in: 1 week
  tags:
    - docker

test-validation:
  stage: test
  image: bash:latest
  script:
    - echo "Running validation library tests..."
    - bash tests/cli/test_validation.sh
  artifacts:
    when: always
    paths:
      - tests/cli/*.log
    expire_in: 1 week
  tags:
    - docker

test-config:
  stage: test
  image: bash:latest
  script:
    - echo "Running configuration tests..."
    - bash tests/cli/test_config.sh
  artifacts:
    when: always
    paths:
      - tests/cli/*.log
    expire_in: 1 week
  tags:
    - docker

test-primus-cli:
  stage: test
  image: bash:latest
  script:
    - echo "Running primus-cli tests..."
    - bash tests/cli/test_primus_cli.sh
  artifacts:
    when: always
    paths:
      - tests/cli/*.log
    expire_in: 1 week
  tags:
    - docker

test-helpers:
  stage: test
  image: bash:latest
  script:
    - echo "Running helper tests..."
    - bash tests/cli/test_helpers.sh
  artifacts:
    when: always
    paths:
      - tests/cli/*.log
    expire_in: 1 week
  tags:
    - docker

test-all:
  stage: test
  image: bash:latest
  script:
    - echo "Running all CLI tests..."
    - bash tests/cli/run_all_tests.sh
  artifacts:
    when: always
    paths:
      - tests/cli/*.log
    expire_in: 1 week
  tags:
    - docker

# Integration Stage
integration-dry-run:
  stage: integration
  image: bash:latest
  script:
    - echo "Testing primus-cli commands..."
    - bash runner/primus-cli --version
    - bash runner/primus-cli --help
    - bash runner/primus-cli --show-config
    - bash runner/primus-cli --dry-run direct -- train pretrain --config test.yaml || true
  tags:
    - docker

integration-config:
  stage: integration
  image: bash:latest
  script:
    - echo "Testing configuration loading..."
    - |
      cat > /tmp/test-config.yaml << 'EOF'
      global:
        log_level: DEBUG
      distributed:
        gpus_per_node: 4
      EOF
    - bash runner/primus-cli --config /tmp/test-config.yaml --show-config
  tags:
    - docker

docs-check:
  stage: integration
  image: alpine:latest
  script:
    - echo "Checking documentation..."
    - test -f README.md
    - test -f docs/USER_GUIDE.md
    - test -f docs/BEST_PRACTICES.md
    - test -f docs/CONFIGURATION_GUIDE.md
    - test -f runner/QUICK_REFERENCE.md
    - echo "✅ All documentation files exist"
  tags:
    - docker

version-check:
  stage: integration
  image: bash:latest
  script:
    - echo "Checking version..."
    - test -f VERSION
    - VERSION=$(cat VERSION)
    - echo "Version: $VERSION"
    - |
      if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
        echo "ERROR: Invalid version format"
        exit 1
      fi
    - echo "✅ Version format valid"
  tags:
    - docker

# Deploy Stage (manual)
deploy-docs:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying documentation..."
    - echo "This is a placeholder for documentation deployment"
    - echo "Configure this based on your documentation hosting"
  when: manual
  only:
    - main
  tags:
    - docker

deploy-release:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Creating release..."
    - VERSION=$(cat VERSION)
    - echo "Release version: $VERSION"
    - echo "This is a placeholder for release creation"
    - echo "Configure this based on your release process"
  when: manual
  only:
    - tags
  tags:
    - docker

# Test coverage report
coverage:
  stage: integration
  image: bash:latest
  script:
    - echo "Generating test coverage report..."
    - |
      TOTAL_TESTS=$(grep -r "test_pass\|test_fail" tests/cli/test_*.sh | wc -l)
      echo "Total test assertions: $TOTAL_TESTS"
      echo "Test files:"
      ls -1 tests/cli/test_*.sh
    - bash tests/cli/run_all_tests.sh || true
  artifacts:
    when: always
    paths:
      - tests/cli/*.log
    expire_in: 1 month
  tags:
    - docker

# Cache test results between pipelines
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - tests/cli/*.log

# Only run full pipeline on main and develop branches
workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_TAG'
